<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FullCalendar Example</title>
    <link href='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css' rel='stylesheet'/>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js'></script>
    <script>
        const urlParams = new URL(location.href).searchParams;
        const id = urlParams.get('id');
        $(document).ready(function () {
            var amenityData = {
                "id": 1,
                // 기타 필드 생략...
                "roundList": [
                    {
                        "id": 1,
                        "roundCellList": [
                            {"id": 1, "roundCellDate": "2024-02-01"},
                            {"id": 2, "roundCellDate": "2024-02-02"},
                            {"id": 3, "roundCellDate": "2024-02-03"}
                        ]
                    },
                    {
                        "id": 2,
                        "roundCellList": [
                            {"id": 4, "roundCellDate": "2024-02-01"}
                        ]
                    }
                ]
            };

            // 날짜별 roundCellDate 개수 계산
            var dateCounts = {};
            amenityData.roundList.forEach(function (round) {
                round.roundCellList.forEach(function (cell) {
                    if (!dateCounts[cell.roundCellDate]) {
                        dateCounts[cell.roundCellDate] = 0;
                    }
                    dateCounts[cell.roundCellDate] += 1;
                });
            });

            // FullCalendar 이벤트 객체 생성
            var events = Object.keys(dateCounts).map(function (date) {
                return {
                    title: dateCounts[date].toString(), // 개수를 제목으로 사용
                    start: date
                };
            });

            // FullCalendar 초기화
            $('#calendar').fullCalendar({
                events: events,
                dayRender: function (day, cell) {
                    var dateStr = day.format('YYYY-MM-DD');
                    if (!dateCounts[dateStr]) {
                        // 데이터가 없는 날짜 비활성화
                        cell.css("background-color", "#eee");
                        cell.css("pointer-events", "none");
                        cell.css("opacity", "0.6");
                    }
                },
                dayClick: function (date, jsEvent, view) {
                    console.log('Clicked date: ' + date.format());
                    $.ajax({
                        url: '/round/read?id=' + id + "&date=" + date.format(),
                        type: 'GET',
                        success: function (data) {
                            console.log(data);
                            var table = $('<table>').addClass('table');
                            // 속성별로 행 추가
                            data.forEach(function (item) {
                                if (item.state === true) {
                                    table.append('<tr><td>' + item.roundName + '<button onclick="AddReserve(' + item.roundCellId + ')">예약하기</button></td></tr>');
                                } else {
                                    table.append('<tr><td>' + item.roundName + '<button disabled onclick="AddReserve(' + item.roundCellId + ')">예약하기</button></td></tr>');
                                }
                            });

                            $('#roundDetail').html(table);
                        }
                    });
                    // 여기에 추가적인 동작을 구현할 수 있습니다.
                }
            });
        });

        function AddReserve(id) {

            var formData = {
                id: id
            };

            $.ajax({
                url: '/reserve',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function (response) {
                    if(response === true){
                        location.href = "/mypage/reserve"
                    }
                    alert(response);
                }
            });
        }
    </script>
</head>
<body>
<div id="calendar"></div>
<div id="roundDetail"></div>
</body>
</html>